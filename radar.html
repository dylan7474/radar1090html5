<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>radar1090 // AI ENHANCED</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- AI Styles -->
  <style>
    /* Interaction Overlay for Audio Permissions */
    #interaction-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5, 5, 5, 0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; backdrop-filter: blur(5px);
    }
    #start-btn {
      border: 2px solid #00ff41; color: #00ff41; background: transparent;
      padding: 20px 40px; font-family: 'Share Tech Mono', monospace;
      font-size: 24px; letter-spacing: 4px; text-transform: uppercase;
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 10px #00ff41; } 100% { opacity: 0.8; } }
    
    /* Dropdown Styling */
    .control-select {
        background: #111; color: #00ff41; border: 1px solid #333;
        font-family: 'Share Tech Mono', monospace; padding: 5px;
        width: 100%; text-transform: uppercase;
    }
  </style>
</head>
<body>

  <!-- 1. INITIALIZATION OVERLAY -->
  <div id="interaction-overlay" onclick="startSystem()">
    <div id="start-btn">INITIALIZE RADAR</div>
    <div style="margin-top: 20px; color: #888; font-family: monospace;">CLICK TO ACTIVATE AI & AUDIO LINKS</div>
  </div>

  <main class="app">
    <div class="panel-toggle-bar" role="group" aria-label="Layout controls">
      <button type="button" class="control-button panel-toggle-button" id="controls-panel-toggle" aria-controls="controls-panel" aria-expanded="true" aria-pressed="true">Hide Controls</button>
      <button type="button" class="control-button panel-toggle-button" id="data-panel-toggle" aria-controls="data-panel" aria-expanded="true" aria-pressed="true">Hide Data</button>
    </div>

    <section class="sidebar controls-panel" id="controls-panel">
      <h1>radar1090 <span style="font-size:0.5em; color:#00ff41;">AI</span></h1>
      <div class="status" id="status"></div>
      <section class="controls">
        <h2>Controls</h2>
        <div class="control-panel">
          
          <!-- AI CONTROLS -->
          <div class="control-row">
            <div class="control-info">
              <span class="control-name" style="color:#00ff41">AI Core</span>
              <span class="control-value" id="ai-status-text">OFFLINE</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button" id="ai-toggle-btn">RETRY</button>
            </div>
          </div>

          <!-- PERSONA SELECTOR -->
          <div class="control-row">
             <div class="control-info">
                <span class="control-name">AI Persona</span>
             </div>
             <div class="control-buttons" style="flex: 2;">
                <select id="ai-persona-select" class="control-select">
                    <option value="MILITARY">Tactical Defense</option>
                    <option value="ATC">Air Traffic Control</option>
                    <option value="SPOTTER">Plane Spotter</option>
                </select>
             </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">Commentary</span>
              <span class="control-value" id="tts-status">ACTIVE</span>
            </div>
            <div class="control-buttons">
               <button type="button" class="control-button" id="tts-mute-toggle">MUTE</button>
            </div>
          </div>
          <!-- END AI CONTROLS -->

          <!-- ORIGINAL CONTROLS -->
          <div class="control-row">
            <div class="control-info">
              <span class="control-name" id="volume-label">Volume</span>
              <span class="control-value" id="volume-value">10</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button control-button--square" id="volume-decrease" aria-label="Decrease volume">&minus;</button>
              <button type="button" class="control-button control-button--square" id="volume-increase" aria-label="Increase volume">+</button>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">Radar Range</span>
              <span class="control-value" id="range-value">50 km</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button control-button--square" id="range-decrease" aria-label="Decrease range">&minus;</button>
              <button type="button" class="control-button control-button--square" id="range-increase" aria-label="Increase range">+</button>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">Base Alert Range</span>
              <span class="control-value" id="alert-range-value">15 km</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button control-button--square" id="alert-range-decrease" aria-label="Decrease base alert range">&minus;</button>
              <button type="button" class="control-button control-button--square" id="alert-range-increase" aria-label="Increase base alert range">+</button>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">Rotate Radar</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button" id="radar-rotate" aria-label="Rotate radar clockwise">Rotate</button>
            </div>
          </div>

          <div class="control-row control-row--single">
            <div class="control-buttons">
              <button type="button" class="control-button" id="center-on-location" aria-label="Center radar on your current location">Use My Location</button>
            </div>
          </div>

          <div class="control-row control-row--single">
            <div class="control-buttons">
              <button type="button" class="control-button" id="manual-location" aria-label="Open the manual receiver location picker">Set Location Manually</button>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">Aircraft Labels</span>
              <span class="control-value" id="aircraft-details-state">Hidden</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button" id="aircraft-details-toggle" aria-pressed="false" aria-label="Toggle aircraft labels">Show</button>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <span class="control-name">OpenStreetMap Overlay</span>
              <span class="control-value" id="openstreetmap-overlay-state">Hidden</span>
            </div>
            <div class="control-buttons">
              <button type="button" class="control-button" id="openstreetmap-overlay-toggle" aria-pressed="false" aria-label="Toggle OpenStreetMap overlay">Show</button>
            </div>
          </div>
        </div>
      </section>
      
      <section class="audio">
        <h2>Live Audio</h2>
        <p class="hint">The local airband feed plays automatically—use mute if you need quiet.</p>
        <div class="audio-actions">
          <button type="button" class="control-button" id="audio-mute-toggle" aria-pressed="false" aria-label="Toggle audio mute">Mute</button>
          <span class="audio-status" id="audio-status">Connecting…</span>
        </div>
        <audio id="airband-stream" preload="none" autoplay muted playsinline>
           Your browser does not support the audio element.
        </audio>
      </section>
    </section>

    <section class="radar-container">
      <div class="version-chip" id="version" aria-label="Application version"></div>
      <div class="openstreetmap-overlay" id="openstreetmap-overlay" hidden aria-hidden="true">
        <iframe id="openstreetmap-frame" title="OpenStreetMap overlay" loading="lazy" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
      </div>
      <canvas id="radar" width="960" height="640" aria-label="Radar display"></canvas>
    </section>

    <section class="sidebar data-panel" id="data-panel">
      <h2>Live Data</h2>
      <div class="info-stack">
        <div class="info-block" id="aircraft-info"></div>
        <div class="info-block" id="range-info"></div>
        <div class="info-block" id="receiver-info" aria-live="polite"></div>
      </div>
      <!-- Ticker used by AI -->
      <div class="message-ticker" id="message-ticker" aria-live="polite">
        <span class="message-ticker__track" id="message-ticker-track"></span>
      </div>
      <div class="message" id="message"></div>
    </section>
  </main>

  <!-- MODALS -->
  <div class="modal" id="geolocation-permission-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" id="geolocation-permission-backdrop" role="presentation"></div>
    <section class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="geolocation-permission-title">
      <h2 id="geolocation-permission-title">Enable location access</h2>
      <p>Location sharing is currently blocked for radar1090. Follow the steps below to allow precise positioning so the radar can center on you automatically.</p>
      <ul class="modal__list">
        <li><strong>Chrome / Edge:</strong> Select the lock icon beside the address bar, open <em>Site settings</em>, set <em>Location</em> to <em>Allow</em>, then reload the page.</li>
        <li><strong>Firefox:</strong> Click the shield icon, choose <em>Allow location access</em>, or clear the block under <em>Permissions</em> in Settings → Privacy &amp; Security.</li>
        <li><strong>Safari:</strong> Open Settings → Privacy &amp; Security → Location Services, allow Safari (and this site), then reload.</li>
      </ul>
      <p class="modal__hint">After updating permissions, reload radar1090 and press “Use My Location” again.</p>
      <div class="modal__actions">
        <button type="button" class="control-button primary" id="geolocation-permission-close">Got it</button>
      </div>
    </section>
  </div>

  <div class="modal" id="manual-location-modal" hidden aria-hidden="true">
    <div class="modal__backdrop" id="manual-location-backdrop" role="presentation"></div>
    <section class="modal__dialog modal__dialog--wide manual-location-modal" role="dialog" aria-modal="true" aria-labelledby="manual-location-title">
      <h2 id="manual-location-title">Set receiver location</h2>
      <p>Pan and zoom the map, then click to drop the marker where your receiver is located. You can drag the marker afterward for fine adjustments.</p>
      <div class="manual-location__map" id="manual-location-map" role="presentation"></div>
      <p class="manual-location__coordinates" id="manual-location-coordinates">Click the map to drop the marker.</p>
      <p class="manual-location__status" id="manual-location-status" hidden aria-live="polite"></p>
      <div class="modal__actions">
        <button type="button" class="control-button" id="manual-location-cancel">Cancel</button>
        <button type="button" class="control-button primary" id="manual-location-confirm" disabled>Use This Location</button>
      </div>
    </section>
  </div>

  <script type="module" src="app.js"></script>

  <!-- 4. AI CONTROLLER SCRIPT -->
  <script>
    const AI_CONFIG = {
        dump1090Base: "http://192.168.50.100:8080/dump1090-fa/data", // Base URL for data
        ollamaUrl: "http://127.0.0.1:11434", 
        ollamaModel: null,
        // Default location (Fallback)
        myLat: 54.531836, 
        myLon: -1.087954, 
        scanInterval: 20000, 
        maxPlanes: 5
    };

    // Prompt Personas
    const PERSONAS = {
        MILITARY: `You are a TACTICAL DEFENSE COMPUTER. Tone: Cold, precise, military. Focus on threats, velocities, and airspace violations.`,
        ATC: `You are a CIVILIAN AIR TRAFFIC CONTROLLER. Tone: Professional, calm, authoritative. Use aviation phraseology (Flight Levels, Knots, Vectors). Focus on safety and separation.`,
        SPOTTER: `You are an ENTHUSIASTIC PLANE SPOTTER at an airshow. Tone: Excited, casual. Focus on airlines, altitude (low passes), and "cool" aircraft actions.`
    };

    let aiProcessing = false;
    let systemActive = false;
    let voiceEnabled = true;
    let currentUtterance = null;

    function startSystem() {
        document.getElementById('interaction-overlay').style.display = 'none';
        systemActive = true;
        window.speechSynthesis.resume();
        
        // Restore Cookie
        const savedPersona = getCookie("aiPersona");
        if(savedPersona && PERSONAS[savedPersona]) {
            document.getElementById('ai-persona-select').value = savedPersona;
        }

        // 1. Sync Location with Receiver
        updateReceiverLocation().then(() => {
            updateAiStatus("INITIALIZING...", "#ffff00");
            speak("System Online. Sensors Calibrated.");
            detectModel();
            setInterval(runAiCycle, AI_CONFIG.scanInterval);
        });
    }

    // --- FETCH OFFICIAL RECEIVER LOCATION ---
    async function updateReceiverLocation() {
        try {
            const r = await fetch(`${AI_CONFIG.dump1090Base}/receiver.json`);
            if(r.ok) {
                const d = await r.json();
                if(d.lat && d.lon) {
                    AI_CONFIG.myLat = d.lat;
                    AI_CONFIG.myLon = d.lon;
                    console.log(`AI: Synced to Receiver Location: ${d.lat}, ${d.lon}`);
                }
            }
        } catch(e) {
            console.log("AI: Could not fetch receiver.json, using fallback location.");
        }
    }

    function updateAiStatus(msg, color) {
        const el = document.getElementById('ai-status-text');
        if(el) {
            el.innerText = msg;
            el.style.color = color || '#fff';
        }
    }

    function aiLog(title, text, type = 'normal') {
        const ticker = document.getElementById('message-ticker-track');
        const tickerContainer = document.getElementById('message-ticker');
        const time = new Date().toLocaleTimeString();
        const cleanText = text.replace(/\n/g, ' ');
        
        if(ticker) ticker.innerText = `[${time}] ${title}: ${cleanText}`;
        
        if (type === 'alert' && tickerContainer) {
            tickerContainer.style.backgroundColor = 'rgba(255, 50, 50, 0.25)';
            tickerContainer.style.border = '1px solid #ff3333';
        } else if (tickerContainer) {
            tickerContainer.style.backgroundColor = '';
            tickerContainer.style.border = '';
        }
    }

    document.getElementById('ai-toggle-btn').addEventListener('click', detectModel);
    
    document.getElementById('tts-mute-toggle').addEventListener('click', () => {
        voiceEnabled = !voiceEnabled;
        const btn = document.getElementById('tts-mute-toggle');
        const status = document.getElementById('tts-status');
        if(voiceEnabled) {
            btn.innerText = "MUTE";
            status.innerText = "ACTIVE";
            speak("Voice enabled.");
        } else {
            btn.innerText = "UNMUTE";
            status.innerText = "MUTED";
            window.speechSynthesis.cancel();
        }
    });

    // --- RANGE CHANGE HANDLER ---
    function handleRangeChange() {
        window.speechSynthesis.cancel();
        currentUtterance = null;
        updateAiStatus("RANGE UPDATING...", "#ffff00");
        setTimeout(() => {
            aiProcessing = false; 
            runAiCycle();
        }, 500);
    }
    
    document.getElementById('range-increase').addEventListener('click', handleRangeChange);
    document.getElementById('range-decrease').addEventListener('click', handleRangeChange);

    // --- PERSONA CHANGED HANDLER ---
    document.getElementById('ai-persona-select').addEventListener('change', (e) => {
        const newMode = e.target.value;
        setCookie("aiPersona", newMode, 365);
        window.speechSynthesis.cancel();
        currentUtterance = null;
        updateAiStatus("SWITCHING MODE...", "#ffff00");
        aiProcessing = false; 
        runAiCycle(); 
    });

    function speak(text) {
        if (!voiceEnabled) return;
        window.speechSynthesis.cancel();
        
        currentUtterance = new SpeechSynthesisUtterance(text);
        const persona = document.getElementById('ai-persona-select').value;
        currentUtterance.rate = persona === 'ATC' ? 1.0 : 1.1;
        
        const voices = window.speechSynthesis.getVoices();
        
        // --- VOICE SELECTION (UK PRIORITY) ---
        const v = voices.find(v => 
            v.lang === 'en-GB' || 
            v.name.includes("UK English") || 
            v.name.includes("Daniel") || 
            v.name.includes("Arthur") || 
            v.name.includes("Martha")
        );
        
        if (v) {
            currentUtterance.voice = v;
        } else {
            // Fallback
            const vDefault = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha"));
            if (vDefault) currentUtterance.voice = vDefault;
        }
        
        currentUtterance.onend = () => { currentUtterance = null; updateAiStatus("ONLINE", "#00ff41"); };
        updateAiStatus("BROADCASTING...", "#00ff41");
        window.speechSynthesis.speak(currentUtterance);
    }
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

    // --- HELPER TO GET UI RANGE ---
    function getCurrentRangeLimit() {
        const el = document.getElementById('range-value');
        if (el) {
            // Robust parsing to handle "50 km", "50km", " 50 "
            const text = el.innerText || "";
            const match = text.match(/(\d+)/);
            if (match) {
                return parseInt(match[0], 10);
            }
        }
        return 50; // Fallback
    }

    async function detectModel() {
        updateAiStatus("CONNECTING...", "#ffff00");
        try {
            const r = await fetch(`${AI_CONFIG.ollamaUrl}/api/tags`);
            if (!r.ok) throw new Error("Failed");
            const d = await r.json();
            const models = d.models || [];
            if(models.length === 0) throw new Error("No Models");
            
            const m = models.find(x => x.name.includes('llama3')) || models.find(x => x.name.includes('mistral')) || models[0];
            AI_CONFIG.ollamaModel = m.name;
            updateAiStatus("ONLINE", "#00ff41");
            console.log(`AI SYSTEM: Connected to ${m.name}`);
            return true;
        } catch (e) {
            updateAiStatus("ERROR", "#ff3333");
            console.error("Ollama connection failed", e);
            return false;
        }
    }

    async function runAiCycle() {
        if (!systemActive || aiProcessing) return;
        
        if (window.speechSynthesis.speaking) {
            console.log("AI: Channel Busy. Skipping scan.");
            return; 
        }

        if (!AI_CONFIG.ollamaModel) { detectModel(); return; }
        
        aiProcessing = true;
        try {
            // Ensure we update location if it's changed on server
            // await updateReceiverLocation(); // Uncomment if receiver moves (mobile setup)

            const r = await fetch(`${AI_CONFIG.dump1090Base}/aircraft.json`);
            const d = await r.json();
            const valid = (d.aircraft || []).filter(p => p.lat && p.lon);
            
            const enriched = valid.map(p => {
                const dist = getDistance(AI_CONFIG.myLat, AI_CONFIG.myLon, p.lat, p.lon);
                return {
                    id: (p.flight || "UFO").trim(),
                    alt: p.alt_baro || 0,
                    speed: p.gs || 0,
                    lat: p.lat, lon: p.lon,
                    track: p.track || 0,
                    vertRate: p.baro_rate || 0,
                    dist: dist
                };
            }).sort((a, b) => a.dist - b.dist);

            // --- DYNAMIC RANGE FILTERING ---
            const currentMaxRange = getCurrentRangeLimit();
            const inRange = enriched.filter(p => p.dist < currentMaxRange);
            
            if (inRange.length > 0) {
                updateAiStatus("ANALYZING...", "#ffff00");
                
                const alerts = analyzeConditions(inRange);
                const top = inRange.slice(0, AI_CONFIG.maxPlanes);
                const commentary = await generateCommentary(top, inRange.length, alerts);
                
                const isAlert = alerts.length > 0 || top[0].dist < 15;
                const header = isAlert ? `ALERT` : `STATUS`;
                
                aiLog(header, commentary, isAlert ? 'alert' : 'normal');
                speak(commentary);
            }
        } catch (e) {
            console.error("AI Cycle Error", e);
            updateAiStatus("DATA ERROR", "#ff3333");
        }
        aiProcessing = false;
    }

    // --- TELEMETRY ANALYSIS ENGINE ---
    function analyzeConditions(planes) {
        let detected = [];
        const scope = planes.slice(0, 5);
        
        scope.forEach(p => {
            const bearingToMe = calculateBearing(p.lat, p.lon, AI_CONFIG.myLat, AI_CONFIG.myLon);
            let diff = Math.abs(p.track - bearingToMe);
            if (diff > 180) diff = 360 - diff;
            
            if (diff < 20 && p.dist < 50) detected.push(`Target ${p.id} is INBOUND on approach vector.`);
            if (p.vertRate > 2000) detected.push(`Target ${p.id} performing RAPID CLIMB.`);
            if (p.vertRate < -2000) detected.push(`Target ${p.id} performing RAPID DESCENT.`);
            if (p.alt < 1000 && p.dist < 20) detected.push(`Target ${p.id} at LOW ALTITUDE.`);
        });

        for(let i=0; i<scope.length; i++) {
            for(let j=i+1; j<scope.length; j++) {
                const p1 = scope[i];
                const p2 = scope[j];
                const d = getDistance(p1.lat, p1.lon, p2.lat, p2.lon);
                const altDiff = Math.abs(p1.alt - p2.alt);
                if (d < 5 && altDiff < 1000) detected.push(`TRAFFIC ALERT: ${p1.id} and ${p2.id} in CLOSE PROXIMITY.`);
            }
        }
        return detected;
    }

    async function generateCommentary(targets, count, alerts) {
        const personaKey = document.getElementById('ai-persona-select').value;
        const basePersona = PERSONAS[personaKey];

        const report = targets.map(p => {
            let altDesc = p.alt < 1000 ? "LOW" : "HIGH";
            return `${p.id}: Rng ${p.dist.toFixed(0)}km, Alt ${p.alt}ft, Spd ${p.speed}kts, Trk ${p.track}°.`;
        }).join("\n");
        
        const alertSection = alerts.length > 0 ? `CRITICAL ALERTS:\n${alerts.join("\n")}` : "No critical anomalies.";

        const userPrompt = `
            RADAR SUMMARY: ${count} contacts in range.
            CLOSEST TRAFFIC:
            ${report}
            ${alertSection}
            
            INSTRUCTION: Provide a concise status update based on your Persona. If there are Alerts, prioritize them.
        `;

        const res = await fetch(`${AI_CONFIG.ollamaUrl}/api/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: AI_CONFIG.ollamaModel,
                messages: [{role: "system", content: basePersona}, {role: "user", content: userPrompt}],
                stream: false
            })
        });
        const data = await res.json();
        return data.message.content.trim();
    }

    // Math Helpers
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    
    function calculateBearing(lat1, lon1, lat2, lon2) {
        const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
        const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                  Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    // Cookie Helpers
    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0;i < ca.length;i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYNET // DEFENSE GRID</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --radar-green: #00ff41;
            --radar-dim: #003b0f;
            --alert-red: #ff3333;
            --hud-cyan: #00f3ff;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--radar-green);
            font-family: 'Share Tech Mono', monospace;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 450px; 
            grid-template-rows: 60px 1fr 40px;
        }

        /* CRT Overlay */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 900;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            opacity: 0.6;
        }

        /* --- CLICK TO START OVERLAY --- */
        #interaction-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        #start-btn {
            border: 2px solid var(--radar-green);
            color: var(--radar-green);
            background: transparent;
            padding: 20px 40px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 24px;
            letter-spacing: 4px;
            text-transform: uppercase;
            box-shadow: 0 0 20px var(--radar-dim);
            animation: pulse 2s infinite;
            transition: 0.2s;
        }
        #start-btn:hover {
            background: var(--radar-green);
            color: black;
            box-shadow: 0 0 40px var(--radar-green);
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 10px var(--radar-green); } 100% { opacity: 0.8; } }

        /* Header */
        header {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--radar-dim);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: #0a0a0a;
            z-index: 10;
        }
        
        h1 { margin: 0; font-size: 24px; letter-spacing: 4px; text-shadow: 0 0 5px var(--radar-green); }
        .sys-status { font-size: 14px; color: var(--hud-cyan); }

        /* Radar */
        #radar-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 2px solid var(--radar-dim);
            overflow: hidden;
            background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%);
        }

        #radar-scope {
            width: 75vmin;
            height: 75vmin;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 65, 0.3);
            background: 
                repeating-radial-gradient(transparent 0, transparent 19%, var(--radar-dim) 20%),
                linear-gradient(0deg, transparent 49.5%, var(--radar-dim) 50%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, var(--radar-dim) 50%, transparent 50.5%);
            position: relative;
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.1);
        }

        #radar-sweep {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 270deg, rgba(0, 255, 65, 0.5));
            animation: sweep 4s linear infinite;
            border-right: 2px solid var(--radar-green);
        }

        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .blip {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #fff, 0 0 15px var(--hud-cyan);
            z-index: 10;
        }
        
        .blip-label {
            position: absolute;
            top: -18px;
            left: 8px;
            font-size: 10px;
            color: var(--hud-cyan);
            white-space: nowrap;
            background: rgba(0,0,0,0.7);
            padding: 1px 3px;
            border-left: 2px solid var(--hud-cyan);
        }

        /* Comms */
        #comms-panel {
            background: #080808;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
            box-shadow: inset 10px 0 30px -10px rgba(0,0,0,0.8);
        }
        
        .panel-header {
            color: var(--alert-red);
            border-bottom: 1px solid var(--radar-dim);
            padding-bottom: 8px;
            margin-bottom: 15px;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
        }

        #log-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; 
        }

        .log-entry {
            margin-bottom: 15px;
            border-left: 2px solid var(--radar-dim);
            padding-left: 12px;
            font-size: 14px;
            animation: flashIn 0.5s ease-out;
        }
        
        .log-entry.alert { border-left-color: var(--alert-red); color: #ffaaaa; }
        .log-header { font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        .log-body { line-height: 1.4; text-shadow: 0 0 3px rgba(0, 255, 65, 0.4); }

        @keyframes flashIn { 0% { opacity: 0; margin-left: -20px; } 100% { opacity: 1; margin-left: 0; } }

        footer {
            grid-column: 1 / -1;
            border-top: 1px solid var(--radar-dim);
            background: #0a0a0a;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            justify-content: space-between;
            color: #555;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--radar-dim); border-radius: 3px; }
    </style>
</head>
<body>

    <div id="interaction-overlay" onclick="startSystem()">
        <div id="start-btn">INITIALIZE SYSTEM</div>
        <div style="margin-top: 20px; color: #666; font-size: 12px;">CLICK TO AUTHORIZE AUDIO SUBSYSTEMS</div>
    </div>

    <header>
        <h1>SKYNET // <span style="color:var(--alert-red)">DEFENSE_GRID</span></h1>
        <div class="sys-status">
            AI_CORE: <span id="ollama-status">OFFLINE</span> | 
            SENSORS: <span id="radar-status">STANDBY</span>
        </div>
    </header>

    <main style="display: contents;">
        <div id="radar-container">
            <div id="radar-scope">
                <div id="radar-sweep"></div>
            </div>
            <div style="position:absolute; bottom:20px; left:20px; font-size:12px; opacity:0.6;">
                SECTOR: ALPHA-9<br>
                MAX RNG: 300KM
            </div>
        </div>

        <div id="comms-panel">
            <div class="panel-header">
                TACTICAL LOG
                <label style="font-size:10px; cursor:pointer; color:var(--radar-green)">
                    <input type="checkbox" id="tts-toggle" checked> VOICE: ON
                </label>
            </div>
            <div id="log-container"></div>
        </div>
    </main>

    <footer>
        <div id="footer-loc">LOC: 54.5318, -1.0879</div>
        <div id="loading-bar">WAITING FOR AUTHORIZATION...</div>
    </footer>

<script>
    // --- CONFIGURATION ---
    const CONFIG = {
        dump1090Url: "http://192.168.50.100:8080/dump1090-fa/data/aircraft.json",
        ollamaUrl: "http://127.0.0.1:11434", 
        ollamaModel: null, 
        myLat: 54.531836, 
        myLon: -1.087954, 
        scanInterval: 20000, 
        maxPlanesToAnalyze: 4, 
        minDistanceKm: 300   
    };

    let isProcessing = false;
    let systemStarted = false;

    // --- AUDIO ENGINE (FIXED) ---
    
    // 1. PREVENT GARBAGE COLLECTION BUG
    // Chrome sometimes deletes the speech object while it's talking. 
    // Assigning it to a global variable prevents this.
    let currentUtterance = null; 

    function startSystem() {
        document.getElementById('interaction-overlay').style.display = 'none';
        document.getElementById('loading-bar').innerText = "SYSTEM READY";
        systemStarted = true;
        
        // Force audio context wake up
        window.speechSynthesis.resume();
        speak("Defense Grid Online. Sensors initializing.");
        
        // Start Loops
        setInterval(scanTraffic, CONFIG.scanInterval);
        scanTraffic();
    }

    function speak(text) {
        if (!document.getElementById('tts-toggle').checked) return;
        
        // Stop anything currently saying
        window.speechSynthesis.cancel();
        
        // Create new utterance
        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.rate = 1.1; 
        currentUtterance.pitch = 0.8; 
        
        // VOICE SELECTION
        const voices = window.speechSynthesis.getVoices();
        // Look for 'cool' voices, fallback to default
        const v = voices.find(v => v.name.includes("Google US English") || v.name.includes("Daniel") || v.name.includes("Samantha"));
        if (v) currentUtterance.voice = v;

        // IMPORTANT: Nullify on end to free memory cleanly
        currentUtterance.onend = function() {
            currentUtterance = null; 
        };

        window.speechSynthesis.speak(currentUtterance);
    }

    // Ensure voices are loaded (browser quirk)
    window.speechSynthesis.onvoiceschanged = function() {
        window.speechSynthesis.getVoices();
    };


    // --- HELPERS ---
    function setStatus(id, text, active) {
        const el = document.getElementById(id);
        el.innerText = text;
        el.style.color = active ? (id.includes('radar') ? 'var(--radar-green)' : 'var(--hud-cyan)') : '#555';
    }

    function logComms(title, text, type = 'normal') {
        const container = document.getElementById('log-container');
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.innerHTML = `
            <div class="log-header">${new Date().toLocaleTimeString()} // ${title}</div>
            <div class="log-body">${text}</div>
        `;
        container.prepend(div);
    }


    // --- MATH ---
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function updateRadarVisuals(planes) {
        const scope = document.getElementById('radar-scope');
        scope.querySelectorAll('.blip').forEach(b => b.remove());

        planes.forEach(p => {
            const distScale = Math.min(p.dist / CONFIG.minDistanceKm, 1);
            const y = Math.sin((p.lon - CONFIG.myLon) * Math.PI/180) * Math.cos(p.lat * Math.PI/180);
            const x = Math.cos(CONFIG.myLat * Math.PI/180) * Math.sin(p.lat * Math.PI/180) -
                      Math.sin(CONFIG.myLat * Math.PI/180) * Math.cos(p.lat * Math.PI/180) * Math.cos((p.lon - CONFIG.myLon) * Math.PI/180);
            let brng = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;

            const angleRad = (brng - 90) * Math.PI / 180;
            const radius = distScale * 50; 
            
            const cssLeft = 50 + (radius * Math.cos(angleRad));
            const cssTop = 50 + (radius * Math.sin(angleRad));

            const b = document.createElement('div');
            b.className = 'blip';
            b.style.left = `${cssLeft}%`;
            b.style.top = `${cssTop}%`;
            b.innerHTML = `<div class="blip-label">${p.id}</div>`;
            scope.appendChild(b);
        });
    }

    // --- AI GENERATION ---
    async function generateCommentary(targets, count) {
        if (!CONFIG.ollamaModel) return "AI Offline.";

        const report = targets.map(p => {
            let altDesc = p.alt < 500 ? "ON DECK" : p.alt < 5000 ? "LOW ALT" : "HIGH ALT";
            let speedDesc = p.speed > 400 ? "HIGH VELOCITY" : "NOMINAL";
            return `Target ${p.id}: Range ${p.dist.toFixed(0)}km, ${altDesc}, ${speedDesc}.`;
        }).join("\n");

        const systemPrompt = `
            You are a specialized SCI-FI DEFENSE COMPUTER.
            Your job is to analyze radar data and output a single, cool tactical status line.
            DO NOT say "System" or "Defense Grid".
            DO NOT use markdown.
            Examples:
            "Multiple contacts confirmed. Target Alpha is on approach."
            "Airspace compromised. Tracking high velocity bogies."
            "Sector clear. Routine patrols visible."
        `;

        const userPrompt = `
            RADAR DATA: ${count} contacts.
            CLOSEST TARGETS:
            ${report}
            
            Generate Status Alert:
        `;

        try {
            document.getElementById('loading-bar').innerText = "UPLOADING TELEMETRY...";
            
            const res = await fetch(`${CONFIG.ollamaUrl}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: CONFIG.ollamaModel,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    stream: false
                })
            });
            
            const data = await res.json();
            document.getElementById('loading-bar').innerText = "SYSTEM READY";
            return data.message.content.trim(); 

        } catch (e) {
            console.error(e);
            return "Communications link unstable.";
        }
    }

    // --- MAIN LOOP ---
    async function scanTraffic() {
        if (isProcessing || !systemStarted) return;
        isProcessing = true;

        if (!CONFIG.ollamaModel) {
            try {
                const r = await fetch(`${CONFIG.ollamaUrl}/api/tags`);
                const d = await r.json();
                const m = d.models.find(x => x.name.includes('llama3')) || d.models[0];
                CONFIG.ollamaModel = m.name;
                setStatus('ollama-status', 'ONLINE', true);
            } catch (e) {
                setStatus('ollama-status', 'ERROR', false);
                isProcessing = false; return;
            }
        }

        try {
            const r = await fetch(CONFIG.dump1090Url);
            const d = await r.json();
            setStatus('radar-status', 'TRACKING', true);
            
            const valid = (d.aircraft || []).filter(p => p.lat && p.lon);
            
            const enriched = valid.map(p => ({
                id: (p.flight || "UNIDENTIFIED").trim(),
                lat: p.lat, lon: p.lon,
                alt: p.alt_baro || 0,
                speed: p.gs || 0,
                dist: getDistance(CONFIG.myLat, CONFIG.myLon, p.lat, p.lon)
            })).sort((a, b) => a.dist - b.dist);

            const inRange = enriched.filter(p => p.dist < CONFIG.minDistanceKm);
            updateRadarVisuals(inRange);

            if (inRange.length > 0) {
                const top = inRange.slice(0, CONFIG.maxPlanesToAnalyze);
                const commentary = await generateCommentary(top, inRange.length);
                
                const isAlert = top[0].dist < 20; 
                const title = isAlert ? `PROXIMITY ALERT [${top[0].id}]` : `SECTOR STATUS [${inRange.length} TARGETS]`;
                
                logComms(title, commentary, isAlert ? 'alert' : 'normal');
                speak(commentary);
            } else {
                logComms("SCAN COMPLETE", "Sector Clear. No contacts in range.");
            }

        } catch (e) {
            console.error(e);
            setStatus('radar-status', 'NO SIGNAL', false);
        }
        isProcessing = false;
    }

</script>
</body>
</html>
